<!doctype html>
<html>
    <head>
        <meta charset="utf8">
        <title>RTcmix WebAssembly demo</title>
        <script src="glue.js"></script>
        <script>
const moduleReady = new Promise(resolve => (Module.onRuntimeInitialized = resolve))
const context = new AudioContext()
let setupDone = false
let outBuffer
let worklet

async function setup() {
    await moduleReady
    Module._setup(context.sampleRate)
    await context.resume()
    await context.audioWorklet.addModule("worklet.js")
    worklet = new AudioWorkletNode(context, "doublebuffer", {
        numberOfInputs: 0,
        numberOfOutputs: 1,
        processorOptions: { blockSize: Module._BLOCK_SIZE }
    })
    const output = new Float32Array(Module.HEAP32.buffer, Module._output, Module._BLOCK_SIZE)
    worklet.port.onmessage = (event) => {
        // Generate samples.
        Module._process()
        // Fill the buffer and transfer it back.
        event.data.set(output)
        worklet.port.postMessage(event.data, [event.data.buffer])
    }
    worklet.connect(context.destination)
    setupDone = true
}

function more() {
    Module._process(outBuffer, Module._BLOCK_SIZE);
}

async function play() {
    if (!setupDone) {
        await setup()
    }
    const score = document.getElementById("score").value
    Module.ccall("load_score", null, ["string"], [score])
}
        </script>
    </head>
    <body>
        <textarea id="score" rows="20" cols="80">
dur = 5.0
notedur = 1.0
amp = 5000
squish = 2
decay = 2.0
for (st = 0; st < dur; st += 0.11) {
    freq = irand(200, 500)
    pan = irand(0, 1)
    STRUM2(st, notedur, amp, freq, squish, decay, pan)
}</textarea><br />
        <button onclick="play()">Play RTcmix score</button>
    </body>
</html>
